{
  "version": "Notebook/1.0",
  "isLocked": true,
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "query": "",
        "crossComponentResources": [],
        "parameters": [
          {
            "id": "8d37f709-bc34-4993-990e-b38022915a1e",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 86400000,
              "isInitialTime": false,
              "grain": 1,
              "useDashboardTimeRange": false
            },
            "isHiddenWhenLocked": false,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 900000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 1800000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 3600000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 14400000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 43200000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 86400000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 172800000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 259200000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 604800000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 1209600000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 2592000000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 5184000000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 7776000000,
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                }
              ],
              "allowCustom": true
            },
            "timeContextFromParameter": null
          },
          {
            "id": "e1e4b971-e05b-4657-bb86-177000f363fe",
            "version": "KqlParameterItem/1.0",
            "name": "UniqueDestinationsCount",
            "type": 1,
            "isRequired": false,
            "query": "let friendlyUnit = (Count: string) {\r\n    let iCount = toint(Count);\r\n    iff(iCount >= 1000000000000, strcat(iCount / 1000000000000, 'T'),\r\n        iff(iCount >= 1000000000, strcat(iCount / 1000000000, 'B'),\r\n            iff(iCount >= 1000000, strcat(iCount / 1000000, 'M'), \r\n                iff(iCount >= 1000, strcat(iCount / 1000, 'K'), Count)\r\n            )\r\n        )\r\n    );\r\n};\r\nVMConnection\r\n| where TimeGenerated {TimeRange}\r\n| summarize by RemoteIp\r\n| summarize Count=count()\r\n| project Count=friendlyUnit(tostring(Count))",
            "isHiddenWhenLocked": true,
            "timeContextFromParameter": null,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "5b030457-00c7-4ad5-a5b6-4699fe1bdac8",
            "version": "KqlParameterItem/1.0",
            "name": "ActiveComputersCount",
            "type": 1,
            "isRequired": false,
            "query": "let friendlyUnit = (Count: string) {\r\n    let iCount = toint(Count);\r\n    iff(iCount >= 1000000000000, strcat(iCount / 1000000000000, 'T'),\r\n        iff(iCount >= 1000000000, strcat(iCount / 1000000000, 'B'),\r\n            iff(iCount >= 1000000, strcat(iCount / 1000000, 'M'), \r\n                iff(iCount >= 1000, strcat(iCount / 1000, 'K'), Count)\r\n            )\r\n        )\r\n    );\r\n};\r\nVMConnection\r\n| where TimeGenerated {TimeRange}\r\n| summarize by Computer\r\n| summarize Count=count()\r\n| project Count=friendlyUnit(tostring(Count))",
            "isHiddenWhenLocked": true,
            "timeContextFromParameter": null,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "a4752c1b-f8cc-4b46-bb1e-2d98ceb0703f",
            "version": "KqlParameterItem/1.0",
            "name": "OutboundMaliciousTrafficCount",
            "type": 1,
            "isRequired": false,
            "query": "let friendlyUnit = (Count: string) {\r\n    let iCount = toint(Count);\r\n    iff(iCount >= 1000000000000, strcat(iCount / 1000000000000, 'T'),\r\n        iff(iCount >= 1000000000, strcat(iCount / 1000000000, 'B'),\r\n            iff(iCount >= 1000000, strcat(iCount / 1000000, 'M'), \r\n                iff(iCount >= 1000, strcat(iCount / 1000, 'K'), Count)\r\n            )\r\n        )\r\n    );\r\n};\r\nunion isfuzzy=true (VMConnection\r\n| where Direction == 'outbound'\r\n| extend Country=RemoteCountry, MaliciousIP=MaliciousIp), (WindowsFirewall\r\n| where CommunicationDirection == 'SEND'\r\n| extend Country=MaliciousIPCountry), (CommonSecurityLog\r\n| where CommunicationDirection == 'Outbound'\r\n| extend Country=MaliciousIPCountry)\r\n| where isnotempty(MaliciousIP) and isnotempty(Country)\r\n| where TimeGenerated {TimeRange}\r\n| summarize by Computer\r\n| summarize Count=count()\r\n| project Count=friendlyUnit(tostring(Count))",
            "isHiddenWhenLocked": true,
            "timeContextFromParameter": null,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "73672024-a6c4-49c6-b4cc-0cfbfd5daae0",
            "version": "KqlParameterItem/1.0",
            "name": "InboundCount",
            "type": 1,
            "isRequired": false,
            "query": "let friendlyUnit = (Count: string) {\r\n    let iCount = toint(Count);\r\n    iff(iCount >= 1000000000000, strcat(iCount / 1000000000000, 'T'),\r\n        iff(iCount >= 1000000000, strcat(iCount / 1000000000, 'B'),\r\n            iff(iCount >= 1000000, strcat(iCount / 1000000, 'M'), \r\n                iff(iCount >= 1000, strcat(iCount / 1000, 'K'), Count)\r\n            )\r\n        )\r\n    );\r\n};\r\nVMConnection\r\n| where Direction == 'inbound'\r\n| summarize Count=count()\r\n| project Count=friendlyUnit(tostring(Count))",
            "isHiddenWhenLocked": true,
            "timeContextFromParameter": null,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "15e4ef79-1abe-49df-8c0a-d719e2635038",
            "version": "KqlParameterItem/1.0",
            "name": "OutboundCount",
            "type": 1,
            "isRequired": false,
            "query": "let friendlyUnit = (Count: string) {\r\n    let iCount = toint(Count);\r\n    iff(iCount >= 1000000000000, strcat(iCount / 1000000000000, 'T'),\r\n        iff(iCount >= 1000000000, strcat(iCount / 1000000000, 'B'),\r\n            iff(iCount >= 1000000, strcat(iCount / 1000000, 'M'), \r\n                iff(iCount >= 1000, strcat(iCount / 1000, 'K'), Count)\r\n            )\r\n        )\r\n    );\r\n};\r\nVMConnection\r\n| where TimeGenerated {TimeRange}\r\n| where Direction == 'outbound'\r\n| summarize Count=count()\r\n| project Count=friendlyUnit(tostring(Count))",
            "isHiddenWhenLocked": true,
            "timeContextFromParameter": null,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "0248fd53-f129-41b4-918f-b5dc6bfa4cb1",
            "version": "KqlParameterItem/1.0",
            "name": "DistinctMaliciousIPAddressesCount",
            "type": 1,
            "isRequired": false,
            "query": "let friendlyUnit = (Count: string) {\r\n    let iCount = toint(Count);\r\n    iff(iCount >= 1000000000000, strcat(iCount / 1000000000000, 'T'),\r\n        iff(iCount >= 1000000000, strcat(iCount / 1000000000, 'B'),\r\n            iff(iCount >= 1000000, strcat(iCount / 1000000, 'M'), \r\n                iff(iCount >= 1000, strcat(iCount / 1000, 'K'), Count)\r\n            )\r\n        )\r\n    );\r\n};\r\nVMConnection\r\n| where TimeGenerated {TimeRange}\r\n| summarize Count=dcount(MaliciousIp)\r\n| project Count=friendlyUnit(tostring(Count))",
            "isHiddenWhenLocked": true,
            "timeContextFromParameter": null,
            "resourceType": "microsoft.operationalinsights/workspaces"
          }
        ],
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "conditionalVisibility": null
    },
    {
      "type": 1,
      "content": {
        "json": "## Threat Intelligence"
      },
      "conditionalVisibility": null
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let schemaColumns = datatable(RemoteIPCountry:string)[];\r\nunion isfuzzy=true\r\n(VMConnection | project-rename MaliciousIP = MaliciousIp | project-rename RemoteIPCountry = RemoteCountry),\r\nschemaColumns, W3CIISLog, DnsEvents, WindowsFirewall, CommonSecurityLog\r\n| where isnotempty(MaliciousIP) and (isnotempty(MaliciousIPCountry) or isnotempty(RemoteIPCountry))\r\n| where TimeGenerated {TimeRange}\r\n| summarize Value = count() by IndicatorThreatType",
        "showQuery": false,
        "size": 0,
        "aggregation": 0,
        "showAnnotations": false,
        "showAnalytics": true,
        "title": "Detected threat types",
        "noDataMessage": "No threat types detected",
        "timeContextFromParameter": null,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "piechart"
      },
      "conditionalVisibility": null,
      "customWidth": "33"
    },
    {
      "type": 1,
      "content": {
        "json": "<br/><br/>\r\nServers with outbound potential malicious traffic\r\n\r\n<h1 style=\"font-size:5rem;\">{OutboundMaliciousTrafficCount}</h1>"
      },
      "conditionalVisibility": null,
      "customWidth": "34"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let schemaColumns = datatable(RemoteIPCountry:string)[];\r\nlet datasource = union isfuzzy=true\r\n(VMConnection | project-rename MaliciousIP = MaliciousIp | project-rename RemoteIPCountry = RemoteCountry),\r\nschemaColumns, W3CIISLog, DnsEvents, WindowsFirewall, CommonSecurityLog;\r\nlet maliciousIps = datasource\r\n| where TimeGenerated {TimeRange}\r\n| where isnotempty(MaliciousIP) and (isnotempty(MaliciousIPCountry) or isnotempty(RemoteIPCountry));\r\nlet inboundConnections = maliciousIps\r\n| where Direction == 'inbound'\r\n| summarize InboundCount = count() by RemoteIPCountry\r\n| project RemoteIPCountry, InboundCount;\r\nlet outboundConnections = maliciousIps\r\n| where Direction != 'inbound'\r\n| summarize OutboundCount = count() by RemoteIPCountry\r\n| project RemoteIPCountry, OutboundCount;\r\nlet nullToZero = (Count: int) {\r\n    iff(isnull(Count), 0, Count);\r\n};\r\ninboundConnections\r\n| join kind=fullouter outboundConnections on RemoteIPCountry\r\n| project Country=RemoteIPCountry, InboundCount=nullToZero(InboundCount), OutboundCount=nullToZero(OutboundCount)",
        "showQuery": false,
        "size": 0,
        "aggregation": 0,
        "showAnnotations": false,
        "showAnalytics": true,
        "title": "Threat breakdown by Country",
        "noDataMessage": "No threats found",
        "timeContextFromParameter": null,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "InboundCount",
              "formatter": 3,
              "formatOptions": {
                "min": 0,
                "palette": "lightBlue"
              },
              "numberFormat": {
                "unit": 17,
                "options": {
                  "style": "decimal"
                }
              }
            },
            {
              "columnMatch": "OutboundCount",
              "formatter": 3,
              "formatOptions": {
                "min": 0,
                "palette": "orange"
              },
              "numberFormat": {
                "unit": 17,
                "options": {
                  "style": "decimal"
                }
              }
            }
          ],
          "rowLimit": 10000,
          "filter": true
        }
      },
      "conditionalVisibility": null,
      "customWidth": "33"
    },
    {
      "type": 1,
      "content": {
        "json": ""
      },
      "conditionalVisibility": null
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "SecurityDetection\r\n| where AlertSeverity == 'High' or AlertSeverity == 'Medium' or AlertSeverity == 'Low'\r\n| where TimeGenerated {TimeRange}\r\n| summarize count() by AlertSeverity, bin(TimeGenerated, {TimeRange:grain})\r\n| order by TimeGenerated",
        "showQuery": false,
        "size": 0,
        "aggregation": 0,
        "showAnnotations": false,
        "showAnalytics": true,
        "title": "Security Detections",
        "noDataMessage": "No security detections found",
        "timeContextFromParameter": null,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "categoricalbar"
      },
      "conditionalVisibility": null,
      "customWidth": "33"
    },
    {
      "type": 1,
      "content": {
        "json": ""
      },
      "conditionalVisibility": null
    },
    {
      "type": 1,
      "content": {
        "json": "<br/><br/>\r\nDistinct malicious IP addresses\r\n\r\n<h1>{DistinctMaliciousIPAddressesCount}</h1>\r\n\r\n<br/><br/>\r\n\r\nInbound communication\r\n\r\n<h1>{InboundCount}</h1>"
      },
      "conditionalVisibility": null,
      "customWidth": "17"
    },
    {
      "type": 1,
      "content": {
        "json": "<br/><br/>\r\nComputers reporting data\r\n\r\n<h1>{ActiveComputersCount}</h1>\r\n\r\n<br/><br/>\r\n\r\nOutbound communication\r\n\r\n<h1>{OutboundCount}</h1>"
      },
      "conditionalVisibility": null,
      "customWidth": "17"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "VMConnection\r\n| where TimeGenerated {TimeRange}\r\n| summarize Data=sum(BytesReceived + BytesSent ), Sent=sum(BytesSent), Received=sum(BytesReceived) by Computer\r\n| project Computer=strcat('🖥️ ', Computer), Data, Sent, Received\r\n| sort by Data desc",
        "showQuery": false,
        "size": 0,
        "aggregation": 0,
        "showAnnotations": false,
        "showAnalytics": true,
        "title": "Top active computers",
        "noDataMessage": "No active computers detected",
        "timeContextFromParameter": null,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Data",
              "formatter": 8,
              "formatOptions": {},
              "numberFormat": {
                "unit": 2,
                "options": {
                  "style": "decimal",
                  "useGrouping": false
                }
              }
            },
            {
              "columnMatch": "Sent",
              "formatter": 8,
              "formatOptions": {},
              "numberFormat": {
                "unit": 2,
                "options": {
                  "style": "decimal"
                }
              }
            },
            {
              "columnMatch": "Received",
              "formatter": 8,
              "formatOptions": {},
              "numberFormat": {
                "unit": 2,
                "options": {
                  "style": "decimal"
                }
              }
            }
          ],
          "rowLimit": 10000,
          "filter": true
        }
      },
      "conditionalVisibility": null,
      "customWidth": "33"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "VMConnection\r\n| where TimeGenerated {TimeRange}\r\n| summarize Data=sum(BytesReceived + BytesSent), Received=sum(BytesReceived), Sent=sum(BytesSent), Sessions=dcount(ConnectionId) by RemoteIp\r\n| sort by Data desc",
        "showQuery": false,
        "size": 0,
        "aggregation": 0,
        "showAnnotations": false,
        "showAnalytics": true,
        "title": "Top destinations",
        "noDataMessage": "No destination traffic found",
        "timeContextFromParameter": null,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Data",
              "formatter": 8,
              "formatOptions": {},
              "numberFormat": {
                "unit": 2,
                "options": {
                  "style": "decimal"
                }
              }
            },
            {
              "columnMatch": "Received",
              "formatter": 8,
              "formatOptions": {},
              "numberFormat": {
                "unit": 2,
                "options": {
                  "style": "decimal"
                }
              }
            },
            {
              "columnMatch": "Sent",
              "formatter": 8,
              "formatOptions": {},
              "numberFormat": {
                "unit": 2,
                "options": {
                  "style": "decimal"
                }
              }
            },
            {
              "columnMatch": "Sessions",
              "formatter": 8,
              "formatOptions": {
                "palette": "green"
              },
              "numberFormat": {
                "unit": 17,
                "options": {
                  "style": "decimal"
                }
              }
            }
          ],
          "rowLimit": 10000,
          "filter": true
        }
      },
      "conditionalVisibility": null,
      "customWidth": "33"
    },
    {
      "type": 1,
      "content": {
        "json": ""
      },
      "conditionalVisibility": null
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "VMConnection\r\n| where TimeGenerated {TimeRange}\r\n| summarize count() by Direction, bin(TimeGenerated, {TimeRange:grain})",
        "showQuery": false,
        "size": 0,
        "aggregation": 0,
        "showAnnotations": false,
        "showAnalytics": true,
        "title": "VMConnection Traffic",
        "noDataMessage": "No traffic detected",
        "timeContextFromParameter": null,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "categoricalbar"
      },
      "conditionalVisibility": null,
      "customWidth": "33"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "VMConnection\r\n| where TimeGenerated {TimeRange}\r\n| extend workbookTrafficType = iff(isempty(MaliciousIp), 'Benign', 'Malicious')\r\n| summarize count() by workbookTrafficType",
        "showQuery": false,
        "size": 0,
        "aggregation": 0,
        "showAnnotations": false,
        "showAnalytics": true,
        "title": "Malicious communications",
        "noDataMessage": "No malicious communications have been detected",
        "timeContextFromParameter": null,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "piechart"
      },
      "conditionalVisibility": null,
      "customWidth": "34"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "VMConnection\r\n| where TimeGenerated {TimeRange}\r\n| where isnotempty(MaliciousIp)\r\n| summarize Count=count() by MaliciousIp",
        "showQuery": false,
        "size": 0,
        "aggregation": 0,
        "showAnnotations": false,
        "showAnalytics": true,
        "title": "Malicious traffic breakdown by IP address",
        "noDataMessage": "No malicious traffic detected",
        "timeContextFromParameter": null,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Count",
              "formatter": 3,
              "formatOptions": {},
              "numberFormat": {
                "unit": 17,
                "options": {
                  "style": "decimal"
                }
              }
            }
          ],
          "rowLimit": 10000,
          "filter": true
        }
      },
      "conditionalVisibility": null,
      "customWidth": "33"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
